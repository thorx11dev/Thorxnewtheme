<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google IMA Video Ads Integration</title>
    <script src="https://imasdk.googleapis.com/js/sdkloader/ima3.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        #video-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            height: 360px;
            margin: 20px auto;
            background-color: #000;
        }
        #content-video {
            width: 100%;
            height: 100%;
        }
        #ad-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .reward-message {
            text-align: center;
            padding: 15px;
            background: #4CAF50;
            color: white;
            border-radius: 5px;
            margin-top: 20px;
            display: none;
        }
    </style>
</head>
<body>
    <h1>Google IMA Video Ads</h1>
    <p>Watch the full video ad to earn 15 points!</p>
    
    <div id="video-container">
        <video id="content-video" controls></video>
        <div id="ad-container"></div>
    </div>
    
    <div id="reward-message" class="reward-message"></div>
    
    <script>
        // Google IMA SDK variables
        let adsManager;
        let adsLoader;
        let adDisplayContainer;
        let videoContent;
        
        // Configuration
        const AD_TAG_URL = 'https://pubads.g.doubleclick.net/gampad/ads?' +
            'iu=/21775744923/external/single_ad_samples&' +
            'sz=640x480&' +
            'cust_params=sample_ct%3Dlinear&' +
            'ciu_szs=300x250%2C728x90&' +
            'gdfp_req=1&' +
            'output=vast&' +
            'unviewed_position_start=1&' +
            'env=vp&' +
            'impl=s&' +
            'correlator=';
        
        /**
         * Initialize video player and IMA SDK
         */
        function initPlayer() {
            videoContent = document.getElementById('content-video');
            videoContent.src = ''; // Optional: add content video URL
            
            initializeIMA();
        }
        
        /**
         * Initialize Google IMA SDK
         */
        function initializeIMA() {
            // Create ad display container
            adDisplayContainer = new google.ima.AdDisplayContainer(
                document.getElementById('ad-container'),
                videoContent
            );
            
            // Create ads loader
            adsLoader = new google.ima.AdsLoader(adDisplayContainer);
            
            // Listen for ads manager loaded
            adsLoader.addEventListener(
                google.ima.AdsManagerLoadedEvent.Type.ADS_MANAGER_LOADED,
                onAdsManagerLoaded,
                false
            );
            
            // Listen for ad errors
            adsLoader.addEventListener(
                google.ima.AdErrorEvent.Type.AD_ERROR,
                onAdError,
                false
            );
            
            // Request video ads
            const adsRequest = new google.ima.AdsRequest();
            adsRequest.adTagUrl = AD_TAG_URL;
            adsRequest.linearAdSlotWidth = 640;
            adsRequest.linearAdSlotHeight = 360;
            adsRequest.nonLinearAdSlotWidth = 640;
            adsRequest.nonLinearAdSlotHeight = 150;
            
            adsLoader.requestAds(adsRequest);
        }
        
        /**
         * Handle ads manager loaded event
         */
        function onAdsManagerLoaded(adsManagerLoadedEvent) {
            const adsRenderingSettings = new google.ima.AdsRenderingSettings();
            adsRenderingSettings.restoreCustomPlaybackStateOnAdBreakComplete = true;
            
            adsManager = adsManagerLoadedEvent.getAdsManager(
                videoContent,
                adsRenderingSettings
            );
            
            // Add event listeners
            adsManager.addEventListener(
                google.ima.AdEvent.Type.CONTENT_PAUSE_REQUESTED,
                onContentPauseRequested
            );
            adsManager.addEventListener(
                google.ima.AdEvent.Type.CONTENT_RESUME_REQUESTED,
                onContentResumeRequested
            );
            adsManager.addEventListener(
                google.ima.AdEvent.Type.STARTED,
                onAdStarted
            );
            adsManager.addEventListener(
                google.ima.AdEvent.Type.COMPLETE,
                onAdComplete
            );
            
            try {
                // Initialize and start ads
                adDisplayContainer.initialize();
                adsManager.init(640, 360, google.ima.ViewMode.NORMAL);
                adsManager.start();
            } catch (adError) {
                console.error('AdsManager error:', adError);
                videoContent.play();
            }
        }
        
        /**
         * Pause content video when ad starts
         */
        function onContentPauseRequested() {
            videoContent.pause();
        }
        
        /**
         * Resume content video when ad finishes
         */
        function onContentResumeRequested() {
            videoContent.play();
        }
        
        /**
         * Track when ad starts
         */
        function onAdStarted() {
            console.log('Ad started playing');
        }
        
        /**
         * Track ad completion and award points
         */
        function onAdComplete() {
            console.log('Ad completed - awarding user points');
            awardUserPoints();
        }
        
        /**
         * Handle ad errors
         */
        function onAdError(adErrorEvent) {
            console.error('Ad error:', adErrorEvent.getError());
            showMessage('Ad could not be loaded. Please try again.', 'error');
            
            if (adsManager) {
                adsManager.destroy();
            }
        }
        
        /**
         * Award user points via backend API
         */
        async function awardUserPoints() {
            try {
                const response = await fetch('/api/google-ima/ad-completion', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: getCurrentUserId(),
                        adNetwork: 'google_ima',
                        timestamp: new Date().toISOString()
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage(`ðŸŽ‰ Congratulations! You earned ${data.points_awarded} points!`, 'success');
                } else {
                    showMessage('Failed to award points. Please contact support.', 'error');
                }
            } catch (error) {
                console.error('Error awarding points:', error);
                showMessage('Network error. Please try again.', 'error');
            }
        }
        
        /**
         * Display reward message
         */
        function showMessage(message, type) {
            const msgElement = document.getElementById('reward-message');
            msgElement.textContent = message;
            msgElement.style.backgroundColor = type === 'success' ? '#4CAF50' : '#f44336';
            msgElement.style.display = 'block';
            
            setTimeout(() => {
                msgElement.style.display = 'none';
            }, 5000);
        }
        
        /**
         * Get current user ID
         */
        function getCurrentUserId() {
            return sessionStorage.getItem('userId') || 'guest-' + Date.now();
        }
        
        // Initialize on page load
        window.addEventListener('load', initPlayer);
    </script>
</body>
</html>
